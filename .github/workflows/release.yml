name: Create Release

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Version type to increment (patch, minor, major)'
        required: true
        default: 'patch'

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Get current version
        id: get_version
        run: |
          VERSION=$(jq -r .version version.json)
          echo "current_version=$VERSION" >> $GITHUB_OUTPUT

      - name: Zip extension
        run: |
          zip -r extension.zip . -x "*.git*" ".github*" "store_assets*" "README.md" "LICENSE" "version.json"

      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.get_version.outputs.current_version }}
          name: Release v${{ steps.get_version.outputs.current_version }}
          files: extension.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Increment version
        id: increment_version
        run: |
          VERSION=${{ steps.get_version.outputs.current_version }}
          IFS='.' read -r major minor patch <<< "$VERSION"
          
          if [ "${{ github.event.inputs.version_type }}" == "major" ]; then
            major=$((major + 1))
            minor=0
            patch=0
          elif [ "${{ github.event.inputs.version_type }}" == "minor" ]; then
            minor=$((minor + 1))
            patch=0
          else
            patch=$((patch + 1))
          fi
          
          NEW_VERSION="$major.$minor.$patch"
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          
          # Update version.json
          echo "{\"version\": \"$NEW_VERSION\"}" > version.json
          
          # Update manifest.json
          jq ".version = \"$NEW_VERSION\"" manifest.json > manifest.json.tmp && mv manifest.json.tmp manifest.json

      - name: Commit and push new version
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add version.json manifest.json
          git commit -m "Bump version to ${{ steps.increment_version.outputs.new_version }} [skip ci]"
          git push origin master
